@page "/app"
@using MongoDB.Bson
@using MongoDB.Driver
@using Watchtower.Data

<PageTitle>Watchtower</PageTitle>

<h1>Watchtower</h1>

@if (hostcount == null) {
    <p>Loading...</p>
} else {
    <table>
    @foreach (var host in hosts)
    {
        <HostComponent host=@host client=@client />
    }
    </table>
}

@code {
    private MongoClient client { get; set; }
    public IMongoDatabase database { get; set; }
    public IEnumerable<WatchtowerHost> hosts { get; set; }
    public int? hostcount { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var currentdir = Directory.GetCurrentDirectory();
        var credentials = System.IO.File.ReadAllText($"{currentdir}/mongodb.txt");

        var settings = MongoClientSettings.FromConnectionString($"mongodb+srv://{credentials}@watchtower.tbosq.mongodb.net/Watchtower?retryWrites=true&w=majority");
        settings.ServerApi = new ServerApi(ServerApiVersion.V1);
        client = new MongoClient(settings);
        database = client.GetDatabase("Main");
        hosts = database.GetCollection<WatchtowerHost>("Hosts")
            .Find(x => true)
            .ToList();
        hostcount = hosts.Count();
    }

    protected async void AddHost(MongoClient client)
    {
        var host = new WatchtowerHost
        {
            hostname = "New Host"
        };
    }
}
